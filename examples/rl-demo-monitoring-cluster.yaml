apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: rl-demo-monitoring-cluster
  namespace: default
spec:
  teamId: "RL"                #First part of metadata.name must match this (lowercapsing is fine)
  volume:
    size: 1Gi                 # Size of persistent volume clain
  numberOfInstances: 1
  # postgres-operator can create users, and placed random passwords in k8s secrets, see below:  
  users:
    rldemo: []
    prometheus: []
  databases:
    rldemo: rldemo
  postgresql:
    version: "12"             # Let's perform an upgrade later
    # This is where we can configure postgreSQL. Recommend not touching shared_buffers
    parameters:
      archive_timeout: "300"  # spilo defaults it to 30 minutes, which may be a tad too long

  # A monitoring sidecar:
  sidecars:
    - name: "monitor"   #Kept short for easy ref on command line
      image: "wrouesnel/postgres_exporter:latest"
      env:
        # Get the password from the secret the operator creates
        - name: "PROMETHEUS_DB_PASSWORD"
          valueFrom:
            secretKeyRef:
              name: prometheus.rl-demo-monitoring-cluster.credentials.postgresql.acid.zalan.do
              key: password

        - name: "DATA_SOURCE_NAME"
          value: "postgresql://prometheus:$(PROMETHEUS_DB_PASSWORD)@$(POD_NAME):5432/postgres?sslmode=require"
